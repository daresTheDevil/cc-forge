#!/usr/bin/env bash
# forge — CC-Forge project CLI
# Installed via: npm install -g cc-forge
#
# Usage:
#   forge init [workspace-id]   Initialize CC-Forge in the current project
#   forge init --force          Re-initialize, overwriting existing files
#   forge build [plan.md]       Run headless TDD build loop from a plan file
#   forge improve [--scope dir] Run continuous improvement loop
#   forge deinit                Remove current project from global registry
#   forge update                Update global CC-Forge install
#   forge version               Show installed version
#   forge help                  Show help

set -euo pipefail

# ---------------------------------------------------------------------------
# Locate install.sh — npm package location takes priority over deployed copy,
# ensuring the globally-installed package version is always used.
# Resolve symlinks first so dirname works correctly for global npm installs
# (e.g. /opt/homebrew/bin/forge → .../node_modules/cc-forge/bin/forge).
# ---------------------------------------------------------------------------
_SCRIPT="${BASH_SOURCE[0]}"
if command -v realpath >/dev/null 2>&1; then
  _SCRIPT="$(realpath "$_SCRIPT")"
fi
PACKAGE_DIR="$(cd "$(dirname "$_SCRIPT")/.." && pwd)"

if [ -f "${PACKAGE_DIR}/install.sh" ]; then
  FORGE_INSTALL="${PACKAGE_DIR}/install.sh"
elif [ -f "${HOME}/.claude/forge/install.sh" ]; then
  FORGE_INSTALL="${HOME}/.claude/forge/install.sh"
else
  printf '[CC-Forge] ❌ install.sh not found.\n' >&2
  printf 'Run: pnpm dlx cc-forge\n' >&2
  exit 1
fi

# ---------------------------------------------------------------------------
# Subcommand routing
# ---------------------------------------------------------------------------
SUBCMD="${1:-help}"
shift || true

case "$SUBCMD" in
  init)
    exec "$FORGE_INSTALL" --project "$@"
    ;;
  build)
    BUILD_SH="${HOME}/.claude/loops/build.sh"
    if [ ! -f "$BUILD_SH" ]; then
      printf '[CC-Forge] ❌ build loop not found. Run: cc-forge --global to install.\n' >&2
      exit 1
    fi
    if [ $# -eq 0 ] || [[ "${1:-}" == --* ]]; then
      PLAN_FILE="$(ls -t plan-*.md 2>/dev/null | head -1)"
      if [ -z "$PLAN_FILE" ]; then
        printf '[CC-Forge] ❌ No plan-*.md file found in current directory.\n' >&2
        printf 'Create one with /forge--plan or specify: forge build <plan.md>\n' >&2
        exit 1
      fi
      printf '[CC-Forge] Using newest plan: %s\n' "$PLAN_FILE"
      exec "$BUILD_SH" "$PLAN_FILE" "$@"
    fi
    exec "$BUILD_SH" "$@"
    ;;
  improve)
    FORGE_LOOP="${HOME}/.claude/loops/forge-loop.sh"
    if [ ! -f "$FORGE_LOOP" ]; then
      printf '[CC-Forge] ❌ forge loop not found. Run: cc-forge --global to install.\n' >&2
      exit 1
    fi
    exec "$FORGE_LOOP" "$@"
    ;;
  update)
    printf '[CC-Forge] Updating to latest version...\n'
    npm install -g cc-forge@latest

    printf '[CC-Forge] Propagating global files...\n'
    NEW_INSTALL="$(npm root -g)/cc-forge/install.sh"
    if [ -f "$NEW_INSTALL" ]; then
      bash "$NEW_INSTALL" --global --force
    else
      printf '[CC-Forge] Warning: could not locate install.sh in npm package — global files not updated.\n' >&2
    fi

    REGISTRY="${HOME}/.claude/forge/registry/global-graph.json"
    if [ -f "$REGISTRY" ] && command -v jq >/dev/null 2>&1; then
      PROJECTS="$(jq -r '.entities[] | select(.type == "forge-project") | .path' "$REGISTRY" 2>/dev/null)"
      if [ -n "$PROJECTS" ]; then
        printf '[CC-Forge] Updating registered projects...\n'
        while IFS= read -r project_path; do
          if [ -d "$project_path" ]; then
            printf '[CC-Forge] Updating: %s\n' "$project_path"
            (cd "$project_path" && forge init --force --quiet) \
              && printf '[CC-Forge] Done: %s\n' "$project_path" \
              || printf '[CC-Forge] Failed: %s\n' "$project_path"
          else
            printf '[CC-Forge] Skipping (directory not found): %s\n' "$project_path"
          fi
        done <<< "$PROJECTS"
      fi
    fi

    printf '[CC-Forge] All done. Run `forge version` to confirm.\n'
    ;;
  deinit)
    REGISTRY="${HOME}/.claude/forge/registry/global-graph.json"
    if [ -f "$REGISTRY" ] && command -v jq >/dev/null 2>&1; then
      PROJECT_NAME="$(basename "$PWD")"
      UPDATED="$(jq --arg path "$PWD" '
        .entities = [.entities[] | select(.path != $path)]
      ' "$REGISTRY")"
      printf '%s' "$UPDATED" > "$REGISTRY"
      printf '[CC-Forge] Project removed from global registry: %s\n' "$PROJECT_NAME"
    else
      printf '[CC-Forge] No registry found — nothing to deregister.\n'
    fi
    ;;
  version|--version|-v)
    PKG="${PACKAGE_DIR}/package.json"
    if [ -f "$PKG" ] && command -v jq >/dev/null 2>&1; then
      printf 'CC-Forge v%s\n' "$(jq -r '.version' "$PKG")"
    else
      printf 'CC-Forge (version unknown)\n'
    fi
    ;;
  help|--help|-h|'')
    printf 'CC-Forge CLI\n\n'
    printf 'Usage: forge <command> [options]\n\n'
    printf 'Commands:\n'
    printf '  init [workspace-id]        Initialize CC-Forge in the current project\n'
    printf '  init --force               Re-initialize, overwriting existing files\n'
    printf '  build [plan.md]            Run headless TDD build loop from a plan file\n'
    printf '  build plan.md --task T003  Resume build loop from a specific task\n'
    printf '  improve                    Run continuous improvement loop (current dir)\n'
    printf '  improve --scope src/       Run improvement loop scoped to a directory\n'
    printf '  deinit                     Remove current project from global registry\n'
  printf '  update                     Update to the latest CC-Forge version\n'
    printf '  version                    Show installed version\n'
    printf '  help                       Show this help\n\n'
    printf 'Examples:\n'
    printf '  forge init\n'
    printf '  forge init applications\n'
    printf '  forge build plan-auth.md\n'
    printf '  forge improve --scope src/\n\n'
    printf 'First time? Run the global installer:\n'
    printf '  npx cc-forge\n\n'
    printf 'After project init, open Claude Code and run /forge--recon\n'
    ;;
  *)
    printf 'Unknown command: %s\n' "$SUBCMD" >&2
    printf 'Run: forge help\n' >&2
    exit 1
    ;;
esac
